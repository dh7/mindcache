name: Deploy Server

on:
  push:
    branches: [main]
    paths:
      - 'packages/server/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        default: false
        type: boolean

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # First, ensure CI passes before deploying
  ci-check:
    runs-on: ubuntu-latest
    name: Verify CI Status
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Run TypeScript check
        run: pnpm exec tsc --noEmit

      - name: Run linter
        run: pnpm run lint

      - name: Run tests
        run: pnpm test

      - name: Build project
        run: pnpm run build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_dummy-key-for-ci-build
          CLERK_SECRET_KEY: sk_test_dummy-key-for-ci-build

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    needs: [ci-check]  # Only deploy if CI passes!
    
    # Optional: Add environment protection for extra safety
    # environment:
    #   name: production
    #   url: https://mindcache-api-production.dh7777777.workers.dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Build shared package
        run: pnpm --filter @mindcache/shared build

      - name: Check for pending migrations
        id: check_migrations
        if: ${{ !inputs.skip_migrations }}
        working-directory: packages/server
        run: |
          PENDING=$(pnpm db:migrations:list 2>&1 || true)
          if echo "$PENDING" | grep -q "No migrations to apply"; then
            echo "has_pending=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No pending migrations"
          else
            echo "has_pending=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Pending migrations detected"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Apply database migrations
        if: steps.check_migrations.outputs.has_pending == 'true' && !inputs.skip_migrations
        working-directory: packages/server
        run: pnpm db:migrate
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Workers
        working-directory: packages/server
        run: pnpm run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment Summary
        run: |
          echo "## üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server deployed to:** https://mindcache-api-production.dh7777777.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # Optional: Run smoke tests after deployment
  smoke-test:
    runs-on: ubuntu-latest
    name: Post-deployment smoke test
    needs: deploy
    
    steps:
      - name: Health check
        run: |
          # Simple health check - adjust URL as needed
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://mindcache-api-production.dh7777777.workers.dev/health || echo "000")
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "404" ]; then
            echo "‚úÖ Server is responding (HTTP $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è Server returned HTTP $HTTP_STATUS"
          fi
